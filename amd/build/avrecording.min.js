define(["core/log","core/modal_factory"],function(a,b){function c(){return navigator.mediaDevices&&window.MediaRecorder?"https:"!==location.protocol&&location.host.indexOf("localhost")===-1?"nothttps":"ok":"nowebrtc"}function d(b,c,d,e,f,g){function h(b){switch(a.debug("Start/stop button clicked."),b.preventDefault(),d.dataset.state){case"new":case"recorded":i();break;case"recording":l()}}function i(){d.disabled=!0,b.hidePlayerDuringRecording?c.parentElement.classList.add("hide"):c.parentElement.classList.remove("hide"),e.classList.add("hide"),d.classList.remove("btn-outline-danger"),d.classList.add("btn-danger"),D=[],E=0,a.debug("Audio question: Starting recording with media constraints"),a.debug(b.mediaConstraints),navigator.mediaDevices.getUserMedia(b.mediaConstraints).then(j)["catch"](n)}function j(b){B=b;var e=z();a.debug("Audio question: creating recorder with opptions"),a.debug(e),C=new MediaRecorder(b,e),C.ondataavailable=k,C.onstop=m,a.debug("Audio question: starting recording."),C.start(1e3),c.srcObject=b,c.setAttribute("muted",""),d.dataset.state="recording",o(),d.disabled=!1}function k(b){a.debug("Audio question: chunk of "+b.data.size+" bytes received."),E+=b.data.size,g.maxUploadSize>=0&&E>=g.maxUploadSize&&(localStorage.getItem("alerted")?localStorage.removeItem("alerted"):(localStorage.setItem("alerted","true"),l(),f.showAlert("nearingmaxsize"))),D.push(b.data),"undefined"!=typeof M.core_formchangechecker&&M.core_formchangechecker.set_form_changed()}function l(){d.disabled=!0,setTimeout(function(){d.disabled=!1},1e3),p(),d.innerText=M.util.get_string("recordagain","qtype_recordrtc"),d.classList.remove("btn-danger"),d.classList.add("btn-outline-danger"),a.debug("Audio question: stopping recording."),C.stop();for(var b=B.getTracks(),c=0;c<b.length;c++)b[c].stop()}function m(){a.debug("Audio question: recording stopped.");var b=new Blob(D,{type:C.mimeType});c.srcObject=null,c.src=URL.createObjectURL(b),c.muted=!1,c.controls=!0,c.parentElement.classList.remove("hide"),d.innerText=M.util.get_string("recordagain","qtype_recordrtc"),d.disabled=!1,d.classList.remove("btn-danger"),d.classList.add("btn-outline-danger"),d.dataset.state="recorded",D.length>0&&f.notifyRecordingComplete(A)}function n(b){a.debug("Audio question: error received"),a.debug(b),d.innerText=M.util.get_string("recordingfailed","qtype_recordrtc"),d.disabled=!1,d.classList.remove("btn-danger"),d.classList.add("btn-outline-danger"),d.dataset.state="new";var c="gum"+b.name.replace("Error","").toLowerCase();f.showAlert(c)}function o(){F=g.timeLimit+1,d.innerHTML=M.util.get_string("stoprecording","qtype_recordrtc")+" (<span></span>)",q(),G=setInterval(q,1e3)}function p(){0!==G&&(clearInterval(G),G=0)}function q(){F-=1;var a=F%60,b=Math.round((F-a)/60);d.querySelector("span").innerText=r(b)+":"+r(a),0===F&&l()}function r(a){var b=a+"";return b.length<2?"0"+b:b}function s(){y("uploadpreparing"),e.classList.remove("hide");var a=new XMLHttpRequest;a.open("GET",c.src),a.responseType="blob",a.addEventListener("load",t),a.send()}function t(a){var c=a.target;if(200===c.status){var d=c.response,e=new FormData;e.append("repo_upload_file",d,b.recordingFilename),e.append("sesskey",M.cfg.sesskey),e.append("repo_id",g.uploadRepositoryId),e.append("itemid",g.draftItemId),e.append("savepath","/"),e.append("ctx_id",g.contextId),e.append("overwrite",1);var f=new XMLHttpRequest;f.addEventListener("readystatechange",u),f.upload.addEventListener("progress",v),f.addEventListener("error",w),f.addEventListener("abort",x),f.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload"),f.send(e)}}function u(a){var b=a.target;4===b.readyState&&200===b.status?y("uploadcomplete"):404===b.status&&y("uploadfailed404")}function v(a){y("uploadprogress",Math.round(a.loaded/a.total*100)+"%")}function w(){y("uploadfailed")}function x(){y("uploadaborted")}function y(a,b){e.querySelector("small").innerText=M.util.get_string(a,"qtype_recordrtc",b)}function z(){var a={};a.audioBitsPerSecond=parseInt(g.audioBitRate,10),"video"===b.name&&(a.videoBitsPerSecond=parseInt(g.videoBitRate,10));for(var c=0;c<b.mimeTypes.length;c++)if(MediaRecorder.isTypeSupported(b.mimeTypes[c])){a.mimeType=b.mimeTypes[c];break}return a}var A=this,B=null,C=null,D=[],E=0,F=0,G=0;d.addEventListener("click",h),this.uploadMediaToServer=s}function e(a,e,h){function i(a){return b.create({type:b.types.ALERT,title:M.util.get_string(a+"_title","qtype_recordrtc"),body:M.util.get_string(a,"qtype_recordrtc")}).then(function(a){return a.show(),a})}function j(a){a.uploadMediaToServer()}var k=document.getElementById(a),l=c();if("nowebrtc"===l)return void k.querySelector(".no-webrtc-warning").classList.remove("hide");if("nothttps"===l)return void k.querySelector(".https-warning").classList.remove("hide");var m;m="audio"===h?f:g;var n=k.querySelector(".record-button button"),o=k.querySelector(".media-player "+h),p=k.querySelector(".saving-message");this.showAlert=i,this.notifyRecordingComplete=j,new d(m,o,n,p,this,e)}var f={name:"audio",recordingFilename:"recording.ogg",hidePlayerDuringRecording:!0,mediaConstraints:{audio:!0},mimeTypes:["audio/webm;codecs=opus","audio/ogg;codecs=opus"]},g={name:"video",recordingFilename:"recording.webm",hidePlayerDuringRecording:!1,mediaConstraints:{audio:!0,video:{width:{ideal:640},height:{ideal:480}}},mimeTypes:["video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/webm;codecs=vp8,opus"]};return{init:function(a,b,c){M.util.js_pending("init-"+a),new e(a,b,c),M.util.js_complete("init-"+a)}}});