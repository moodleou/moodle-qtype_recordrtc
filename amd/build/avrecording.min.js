define("qtype_recordrtc/avrecording",["exports","core/log","core/modal_factory"],(function(_exports,_log,_modal_factory){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * JavaScript to the recording work.
   *
   * We would like to thank the creators of atto_recordrtc, whose
   * work originally inspired this.
   *
   * This script uses some third-party JavaScript and loading that within Moodle/ES6
   * requires some contortions. The main classes here are:
   *
   * * Recorder - represents one recording widget. This works in a way that is
   *   not particularly specific to this question type.
   * * RecordRtcQuestion - represents one question, which may contain several recorders.
   *   It deals with the interaction between the recorders and the question.
   *
   * @module    qtype_recordrtc/avrecording
   * @copyright 2019 The Open University
   * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */function Recorder(widget,mediaSettings,owner,uploadInfo){const recorder=this;let mediaStream=null,mediaRecorder=null,chunks=[],bytesRecordedSoFar=0,timeRemaining=0,stopTime=0,countdownTicker=0;const button=widget.querySelector("button.qtype_recordrtc-main-button"),pauseButton=widget.querySelector(".qtype_recordrtc-pause-button button"),controlRow=widget.querySelector(".qtype_recordrtc-control-row"),mediaElement=widget.querySelector(".qtype_recordrtc-media-player "+mediaSettings.name),noMediaPlaceholder=widget.querySelector(".qtype_recordrtc-no-recording-placeholder"),timeDisplay=widget.querySelector(".qtype_recordrtc-time-left");function handleCaptureStarting(stream){mediaStream=stream,mediaElement.srcObject=stream,mediaElement.muted=!0,"audio"===mediaSettings.name?startSaving():(mediaElement.play(),mediaElement.controls=!1,widget.dataset.state="starting",setButtonLabel("startrecording"),widget.querySelector(".qtype_recordrtc-stop-button").disabled=!1),pauseButton&&(pauseButton.disabled=!1),button.disabled=!1,button.focus()}function startSaving(){mediaRecorder=new MediaRecorder(mediaStream,function(){const options={};if("audio"===mediaSettings.name)options.audioBitsPerSecond=mediaSettings.bitRate;else if("video"===mediaSettings.name){options.videoBitsPerSecond=mediaSettings.bitRate,options.videoWidth=mediaSettings.width,options.videoHeight=mediaSettings.height;for(let i=0;i<mediaSettings.mimeTypes.length;i++)if(MediaRecorder.isTypeSupported(mediaSettings.mimeTypes[i])){options.mimeType=mediaSettings.mimeTypes[i];break}}return options}()),mediaRecorder.ondataavailable=handleDataAvailable,mediaRecorder.onpause=handleDataAvailable,mediaRecorder.onstop=handleRecordingHasStopped,mediaRecorder.start(1e3),widget.dataset.state="recording",setButtonLabel("stoprecording"),timeRemaining=1e3*widget.dataset.maxRecordingDuration,resumeCountdownTimer(),updateTimerDisplay(),"video"===mediaSettings.name&&(button.parentElement.classList.add("hide"),controlRow.classList.remove("hide"),controlRow.classList.add("d-flex"))}function handleDataAvailable(event){event.data&&(bytesRecordedSoFar+=event.data.size,uploadInfo.maxUploadSize>=0&&bytesRecordedSoFar>=uploadInfo.maxUploadSize&&(localStorage.getItem("alerted")?localStorage.removeItem("alerted"):(localStorage.setItem("alerted","true"),stopRecording(),owner.showAlert("nearingmaxsize"))),chunks.push(event.data),void 0===M.core_formchangechecker||window.location.pathname.endsWith("/question/preview.php")||M.core_formchangechecker.set_form_changed())}function stopRecording(){button.disabled=!0,stopCountdownTimer(),button.classList.remove("btn-danger"),button.classList.add("btn-outline-danger"),pauseButton&&(setPauseButtonLabel("pause"),pauseButton.parentElement.classList.add("hide")),mediaRecorder.stop();const tracks=mediaStream.getTracks();for(let i=0;i<tracks.length;i++)tracks[i].stop()}function handleRecordingHasStopped(){if("new"===widget.dataset.state)return;const blob=new Blob(chunks,{type:mediaRecorder.mimeType});mediaElement.srcObject=null,mediaElement.src=URL.createObjectURL(blob),mediaElement.muted=!1,mediaElement.controls=!0,mediaElement.parentElement.classList.remove("hide"),noMediaPlaceholder.classList.add("hide"),mediaElement.focus(),"audio"===mediaSettings.name?timeDisplay.classList.add("hide"):(button.parentElement.classList.remove("hide"),controlRow.classList.add("hide"),controlRow.classList.remove("d-flex")),button.disabled=!0,button.classList.remove("btn-danger"),button.classList.add("btn-outline-danger"),widget.dataset.state="recorded",chunks.length>0&&owner.notifyRecordingComplete(recorder)}function handleCaptureFailed(error){_log.default.debug("Audio/video question: error received"),_log.default.debug(error),setPlaceholderMessage("recordingfailed"),setButtonLabel("recordagainx"),button.classList.remove("btn-danger"),button.classList.add("btn-outline-danger"),widget.dataset.state="new",mediaRecorder&&mediaRecorder.stop();const stringName="gum"+error.name.replace("Error","").toLowerCase();owner.showAlert(stringName),enableAllButtons()}function stopCountdownTimer(){timeRemaining=stopTime-Date.now(),0!==countdownTicker&&(clearInterval(countdownTicker),countdownTicker=0)}function resumeCountdownTimer(){stopTime=Date.now()+timeRemaining,0===countdownTicker&&(countdownTicker=setInterval(updateTimerDisplay,100))}function updateTimerDisplay(){const millisecondsRemaining=stopTime-Date.now(),secondsRemaining=Math.round(millisecondsRemaining/1e3),secs=secondsRemaining%60,mins=Math.round((secondsRemaining-secs)/60);timeDisplay.innerText=M.util.get_string("timedisplay","qtype_recordrtc",{mins:pad(mins),secs:pad(secs)}),millisecondsRemaining<=0&&stopRecording()}function pad(val){const valString=val+"";return valString.length<2?"0"+valString:""+valString}function handleRecordingFetched(e){const fetchRequest=e.target;if(200!==fetchRequest.status)return;const blob=fetchRequest.response,formData=new FormData;formData.append("repo_upload_file",blob,widget.dataset.recordingFilename),formData.append("sesskey",M.cfg.sesskey),formData.append("repo_id",uploadInfo.uploadRepositoryId),formData.append("itemid",uploadInfo.draftItemId),formData.append("savepath","/"),formData.append("ctx_id",uploadInfo.contextId),formData.append("overwrite","1");const uploadRequest=new XMLHttpRequest;uploadRequest.addEventListener("readystatechange",handleUploadReadyStateChanged),uploadRequest.upload.addEventListener("progress",handleUploadProgress),uploadRequest.addEventListener("error",handleUploadError),uploadRequest.addEventListener("abort",handleUploadAbort),uploadRequest.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload"),uploadRequest.send(formData)}function handleUploadReadyStateChanged(e){const uploadRequest=e.target;if(4!==uploadRequest.readyState)return;JSON.parse(uploadRequest.responseText).errorcode&&handleUploadError(),200===uploadRequest.status?(setButtonLabel("recordagainx"),enableAllButtons()):404===uploadRequest.status&&(setPlaceholderMessage("uploadfailed404"),enableAllButtons())}function handleUploadProgress(e){setButtonLabel("uploadprogress",Math.round(e.loaded/e.total*100)+"%")}function handleUploadError(){setPlaceholderMessage("uploadfailed"),enableAllButtons()}function handleUploadAbort(){setPlaceholderMessage("uploadaborted"),enableAllButtons()}function setButtonLabel(langString,a){a||(a='<span class="sr-only">&nbsp;'+widget.dataset.widgetName+"</span>"),button.innerHTML=M.util.get_string(langString,"qtype_recordrtc",a)}function setPauseButtonLabel(langString){pauseButton.innerText=M.util.get_string(langString,"qtype_recordrtc")}function setPlaceholderMessage(langString){noMediaPlaceholder.textContent=M.util.get_string(langString,"qtype_recordrtc"),mediaElement.parentElement.classList.add("hide"),noMediaPlaceholder.classList.remove("hide")}function enableAllButtons(){disableOrEnableButtons(!0),owner.notifyButtonStatesChanged()}function disableOrEnableButtons(){let enabled=arguments.length>0&&void 0!==arguments[0]&&arguments[0];widget.closest(".que").querySelectorAll("button, input[type=submit], input[type=button]").forEach((function(button){button.disabled=!enabled}))}widget.addEventListener("click",(function(e){const clickedButton=e.target.closest("button");if(!clickedButton)return;switch(e.preventDefault(),widget.dataset.state){case"new":case"recorded":!function(){"audio"===mediaSettings.name?(mediaElement.parentElement.classList.add("hide"),noMediaPlaceholder.classList.add("hide"),timeDisplay.classList.remove("hide")):(mediaElement.parentElement.classList.remove("hide"),noMediaPlaceholder.classList.add("hide"));null==pauseButton||pauseButton.parentElement.classList.remove("hide"),button.classList.remove("btn-outline-danger"),button.classList.add("btn-danger"),disableOrEnableButtons(!1),chunks=[],bytesRecordedSoFar=0,navigator.mediaDevices.getUserMedia(mediaSettings.mediaConstraints).then(handleCaptureStarting).catch(handleCaptureFailed)}();break;case"starting":startSaving();break;case"recording":clickedButton===pauseButton?(stopCountdownTimer(),setPauseButtonLabel("resume"),mediaRecorder.pause(),widget.dataset.state="paused"):stopRecording();break;case"paused":clickedButton===pauseButton?(resumeCountdownTimer(),widget.dataset.state="recording",setPauseButtonLabel("pause"),mediaRecorder.resume()):stopRecording()}})),this.uploadMediaToServer=function(){setButtonLabel("uploadpreparing");const fetchRequest=new XMLHttpRequest;fetchRequest.open("GET",mediaElement.src),fetchRequest.responseType="blob",fetchRequest.addEventListener("load",handleRecordingFetched),fetchRequest.send()}}function AudioSettings(bitRate){this.name="audio",this.bitRate=parseInt(bitRate,10),this.mediaConstraints={audio:!0},this.mimeTypes=["audio/mpeg"]}function VideoSettings(bitRate,width,height){this.name="video",this.bitRate=parseInt(bitRate,10),this.width=parseInt(width,10),this.height=parseInt(height,10),this.mediaConstraints={audio:!0,video:{width:{ideal:this.width},height:{ideal:this.height}}},this.mimeTypes=["video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/webm;codecs=vp8,opus"]}function RecordRtcQuestion(questionId,settings){const questionDiv=document.getElementById(questionId),result=navigator.mediaDevices&&window.MediaRecorder?"https:"!==location.protocol&&-1===location.host.indexOf("localhost")?"nothttps":"ok":"nowebrtc";if("nothttps"===result)return void questionDiv.querySelector(".https-warning").classList.remove("hide");if("nowebrtc"===result)return void questionDiv.querySelector(".no-webrtc-warning").classList.remove("hide");this.showAlert=function(subject){return _modal_factory.default.create({type:_modal_factory.default.types.ALERT,title:M.util.get_string(subject+"_title","qtype_recordrtc"),body:M.util.get_string(subject,"qtype_recordrtc")}).then((function(modal){return modal.show(),modal}))},this.notifyRecordingComplete=function(recorder){recorder.uploadMediaToServer()},this.notifyButtonStatesChanged=setSubmitButtonState;const thisQuestion=this;function setSubmitButtonState(){let anyRecorded=!1;questionDiv.querySelectorAll(".qtype_recordrtc-audio-widget, .qtype_recordrtc-video-widget").forEach((function(widget){"recorded"===widget.dataset.state&&(anyRecorded=!0)}));const submitButton=questionDiv.querySelector("input.submit[type=submit]");submitButton&&(submitButton.disabled=!anyRecorded)}questionDiv.querySelectorAll(".qtype_recordrtc-audio-widget, .qtype_recordrtc-video-widget").forEach((function(widget){let typeInfo;return typeInfo="audio"===widget.dataset.mediaType?new AudioSettings(settings.audioBitRate):new VideoSettings(settings.videoBitRate,settings.videoWidth,settings.videoHeight),new Recorder(widget,typeInfo,thisQuestion,settings),"Not used"})),setSubmitButtonState()}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=function(questionId,settings){M.util.js_pending("init-"+questionId),new RecordRtcQuestion(questionId,settings),M.util.js_complete("init-"+questionId)},_log=_interopRequireDefault(_log),_modal_factory=_interopRequireDefault(_modal_factory)}));

//# sourceMappingURL=avrecording.min.js.map